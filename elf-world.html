<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Emoji Zelda Game - Refactored</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: sans-serif;
    }

    .view {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    .world {
      position: absolute;
      display: grid;
      transition: transform 0.1s ease-out;
    }

    .tile {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
    }

    .player, .entity {
      position: absolute;
      width: 1px; /* Will be resized dynamically */
      height: 1px;
    }

    .ui {
      position: absolute;
      top: 0;
      left: 0;
      padding: 0.5rem;
      font-size: 1.2rem;
      background: rgba(255, 255, 255, 0.8);
    }

    .dialogue {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 1rem;
      font-size: 1.2rem;
      display: none;
    }
  </style>
</head>
<body>

<div class="view">
  <div id="world" class="world"></div>
  <div id="player" class="player">üßù‚Äç‚ôÇÔ∏è</div>
  <div class="ui" id="inventory">Inventory: üçé</div>
  <div class="dialogue" id="dialogueBox">Hello!</div>
</div>

<script>
  const COLS = 30
  const ROWS = 20
  const VIEW_WIDTH = 10
  const VIEW_HEIGHT = 8

  let tileWidth, tileHeight
  const worldEl = document.getElementById('world')
  const playerEl = document.getElementById('player')
  const dialogueBox = document.getElementById('dialogueBox')
  const inventoryEl = document.getElementById('inventory')

  const grid = Array.from({ length: ROWS }, () => Array(COLS).fill(null))

  class Entity {
    constructor({ x, y, emoji }) {
      this.x = x
      this.y = y
      this.emoji = emoji
      this.solid = false
      this.el = document.createElement('div')
      this.el.className = 'tile entity'
      this.el.textContent = emoji
      worldEl.appendChild(this.el)
      this.updatePosition()
    }
    updatePosition() {
      this.el.style.left = `${this.x * tileWidth}px`
      this.el.style.top = `${this.y * tileHeight}px`
      this.el.style.width = `${tileWidth}px`
      this.el.style.height = `${tileHeight}px`
    }
    onInteract(player) {}
  }

  class ObjectEntity extends Entity {
    constructor(data) {
      super(data)
      this.solid = true
    }
  }

  class Enemy extends Entity {
    onInteract(player) {
      showDialogue("A wild " + this.emoji + " appears!")
    }
  }

  class NPC extends Entity {
    constructor(data) {
      super(data)
      this.dialogue = data.dialogue || "Hello!"
    }
    onInteract(player) {
      showDialogue(this.dialogue)
      if (!player.inventory.includes('üóùÔ∏è')) {
        player.inventory.push('üóùÔ∏è')
        updateInventory()
      }
    }
  }

  class Player {
    constructor({ x, y, emoji }) {
      this.x = x
      this.y = y
      this.emoji = emoji
      this.inventory = ['üçé']
      this.el = playerEl
    }
    update() {
      this.el.style.left = `${this.x * tileWidth}px`
      this.el.style.top = `${this.y * tileHeight}px`
      this.el.style.width = `${tileWidth}px`
      this.el.style.height = `${tileHeight}px`
    }
    move(dx, dy) {
      const tx = clamp(this.x + dx, 0, COLS - 1)
      const ty = clamp(this.y + dy, 0, ROWS - 1)
      const entity = grid[ty][tx]
      if (entity?.solid) return
      entity?.onInteract(this)
      this.x = tx
      this.y = ty
      this.update()
      updateCamera()
    }
  }

  const entitiesData = [
    { type: 'object', emoji: 'üå≤', x: 5, y: 5 },
    { type: 'enemy', emoji: 'üêç', x: 10, y: 3 },
    { type: 'npc', emoji: 'üë¥', x: 15, y: 8, dialogue: 'Stay safe out there!' }
  ]

  const entityTypes = {
    object: ObjectEntity,
    enemy: Enemy,
    npc: NPC
  }

  const entities = []
  entitiesData.forEach(data => {
    const Cls = entityTypes[data.type]
    const entity = new Cls(data)
    grid[data.y][data.x] = entity
    entities.push(entity)
  })

  const player = new Player({ x: 2, y: 2, emoji: 'üßù‚Äç‚ôÇÔ∏è' })

  let cameraX = player.x
  let cameraY = player.y

  function clamp(val, min, max) {
    return Math.max(min, Math.min(max, val))
  }

  function updateInventory() {
    inventoryEl.textContent = `Inventory: ${player.inventory.join(' ')}`
  }

  function showDialogue(text) {
    dialogueBox.textContent = text
    dialogueBox.style.display = 'block'
    setTimeout(() => dialogueBox.style.display = 'none', 2000)
  }

  function updateCamera() {
    const marginX = Math.floor(VIEW_WIDTH / 2)
    const marginY = Math.floor(VIEW_HEIGHT / 2)
    if (player.x < cameraX - marginX + 1) cameraX = clamp(player.x + marginX - 1, marginX, COLS - marginX - 1)
    if (player.x > cameraX + marginX - 1) cameraX = clamp(player.x - marginX + 1, marginX, COLS - marginX - 1)
    if (player.y < cameraY - marginY + 1) cameraY = clamp(player.y + marginY - 1, marginY, ROWS - marginY - 1)
    if (player.y > cameraY + marginY - 1) cameraY = clamp(player.y - marginY + 1, marginY, ROWS - marginY - 1)

    const offsetX = clamp(cameraX - marginX, 0, COLS - VIEW_WIDTH) * tileWidth
    const offsetY = clamp(cameraY - marginY, 0, ROWS - VIEW_HEIGHT) * tileHeight
    worldEl.style.transform = `translate(${-offsetX}px, ${-offsetY}px)`
    player.el.style.transform = `translate(${-offsetX}px, ${-offsetY}px)`
    entities.forEach(e => e.el.style.transform = `translate(${-offsetX}px, ${-offsetY}px)`)
  }

  window.addEventListener('keydown', e => {
    if (e.key === 'ArrowLeft') player.move(-1, 0)
    else if (e.key === 'ArrowRight') player.move(1, 0)
    else if (e.key === 'ArrowUp') player.move(0, -1)
    else if (e.key === 'ArrowDown') player.move(0, 1)
  })

  function resizeTiles() {
    tileWidth = window.innerWidth / VIEW_WIDTH
    tileHeight = window.innerHeight / VIEW_HEIGHT
    worldEl.style.gridTemplateColumns = `repeat(${COLS}, ${tileWidth}px)`
    worldEl.style.gridTemplateRows = `repeat(${ROWS}, ${tileHeight}px)`
    worldEl.style.width = `${COLS * tileWidth}px`
    worldEl.style.height = `${ROWS * tileHeight}px`
    player.update()
    entities.forEach(e => e.updatePosition())
    updateCamera()
  }

  window.addEventListener('resize', resizeTiles)
  resizeTiles()
</script>
</body>
</html>